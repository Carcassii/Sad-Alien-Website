<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Music - Sad Alien Studios</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Work+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="common.css">
  <style>
    html {
      scroll-behavior: smooth;
    }
    
    body {
      margin: 0;
      font-family: 'Work Sans', sans-serif;
      background: linear-gradient(to bottom, #0a1d37 0%, #0a1d37 320px, #3c75b4 460px, #a0d2ff 640px, #fffdf9 1000px, #fffdf9 100%);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: #fff;
      border-radius: 50%;
      animation: twinkle var(--twinkle-duration) ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.2; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .navbar {
      position: relative;
      height: 320px;
      background: #0a1d37;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
    }

    .navbar::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: none;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    @keyframes float {
      0%, 100% { 
        transform: translate(-50%, -50%); 
      }
      50% { 
        transform: translate(-50%, calc(-50% - 10px)); 
      }
    }

    @keyframes titleGlow {
      0%, 100% {
        text-shadow: 0 0 5px #FFE66D,
                     0 0 10px #FFA500,
                     0 0 15px rgba(255, 165, 0, 0.3);
      }
      50% {
        text-shadow: 0 0 10px #FFE66D,
                     0 0 20px #FFA500,
                     0 0 30px rgba(255, 165, 0, 0.6);
      }
    }

    .site-title {
      position: absolute;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Patrick Hand', cursive;
      font-size: 14.25em;
      color: #FFE66D;
      font-weight: 400;
      z-index: 2;
      text-align: center;
      width: 100%;
      margin: 0;
      line-height: 1;
      animation: float 3.5s ease-in-out infinite,
                 titleGlow 3s ease-in-out infinite;
    }

    .nav-links {
      list-style: none;
      display: flex;
      gap: 1.5rem;
      margin: 0;
      padding: 0;
      z-index: 2;
      transform: translateY(80px);
      justify-content: center;
      flex-wrap: wrap;
      align-items: center;
    }

    .nav-links a {
      font-family: 'Patrick Hand', cursive;
      text-decoration: none;
      color: #fff;
      padding: 0.8rem 1.4rem;
      transition: all 0.3s ease;
      border-radius: 16px;
      position: relative;
      font-size: 1.2rem;
      min-width: 100px;
      text-align: center;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    .nav-links li:nth-child(1) a {
      background: rgba(255, 89, 94, 0.85);
    }
    .nav-links li:nth-child(2) a {
      background: rgba(255, 202, 58, 0.85);
    }
    .nav-links li:nth-child(3) a {
      background: rgba(138, 201, 38, 0.85);
    }
    .nav-links li:nth-child(4) a {
      background: rgba(25, 130, 196, 0.85);
    }
    .nav-links li:nth-child(5) a {
      background: rgba(255, 125, 255, 0.85);
    }

    .nav-links a:hover {
      transform: translateY(-2px) scale(1.1);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3), 0 3px 6px rgba(0,0,0,0.2);
      filter: brightness(1.1);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .synth-container {
      position: relative;
      background: rgba(255, 89, 94, 0.85);
      border: 8px solid rgba(255, 255, 255, 0.2);
      border-radius: 30px;
      padding: 30px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: 120px auto 20px;
      backdrop-filter: blur(4px);
    }

    h1 {
      font-family: 'Patrick Hand', cursive;
      font-size: 2.5em;
      margin-bottom: 0.2em;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .controls-container {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    .instrument-select {
      background: rgba(255, 202, 58, 0.85);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 25px;
      color: #fff;
      flex: 1;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
    }

    .instrument-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .instrument-btn {
      background: rgba(138, 201, 38, 0.85);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 12px 16px;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Patrick Hand', cursive;
      font-size: 1.1em;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
    }

    .instrument-btn:hover {
      transform: translateY(-2px) scale(1.1);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3), 0 3px 6px rgba(0,0,0,0.2);
      filter: brightness(1.1);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .instrument-btn.active {
      background: rgba(25, 130, 196, 0.85);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    .randomize-btn {
      background: rgba(255, 125, 255, 0.85);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 15px 25px;
      border-radius: 16px;
      cursor: pointer;
      font-family: 'Patrick Hand', cursive;
      font-size: 1.3em;
      transition: all 0.3s ease;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      margin-top: 25px;
      width: 100%;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
    }

    .randomize-btn:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3), 0 3px 6px rgba(0,0,0,0.2);
      filter: brightness(1.1);
    }

    .knob {
      background: rgba(255, 89, 94, 0.85);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .knob:nth-child(2n) {
      background: rgba(255, 202, 58, 0.85);
    }

    .knob:nth-child(3n) {
      background: rgba(138, 201, 38, 0.85);
    }

    .knob label {
      font-family: 'Patrick Hand', cursive;
      font-size: 1.4em;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      margin-bottom: 15px;
      display: block;
    }

    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 12px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      outline: none;
      border: 2px solid #fff;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      background: linear-gradient(145deg, #ffffff, #f0f0f0);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      border: 2px solid #fff;
    }

    input[type=range]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
      background: linear-gradient(145deg, #ffffff, #FFE66D);
    }

    .keyboard {
      display: flex;
      justify-content: center;
      position: relative;
      margin-top: 30px;
      padding: 20px;
      height: 200px;
      background: rgba(25, 130, 196, 0.85);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
    }

    .key {
      width: 60px;
      height: 180px;
      background: linear-gradient(to bottom, #ffffff, #e0e0e0);
      border-radius: 0 0 10px 10px;
      cursor: pointer;
      transition: all 0.1s;
      position: relative;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 10px;
      color: #4A4A4A;
      font-weight: bold;
      margin: 0 2px;
      z-index: 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      border: 1px solid rgba(0,0,0,0.1);
      touch-action: manipulation;
    }

    .key.black {
      width: 40px;
      height: 120px;
      background: #4A4A4A;
      position: absolute;
      z-index: 1;
      color: #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      border: 1px solid rgba(0,0,0,0.2);
      border-radius: 0 0 8px 8px;
      transform: translateX(-50%);
      touch-action: manipulation;
    }

    .key:hover, .key:active {
      background: linear-gradient(to bottom, #ffffff, #f0f0f0);
      transform: translateY(2px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .key.black:hover, .key.black:active {
      background: #333333;
      transform: translateY(2px) translateX(-50%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .key.active {
      background: #FFD93D;
      transform: translateY(2px);
      color: #4A4A4A;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    }

    .key.black.active {
      background: #FFD93D;
      color: #4A4A4A;
      transform: translateY(2px) translateX(-50%);
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    }

    .key span {
      font-size: 1.2em;
      opacity: 0.8;
      pointer-events: none;
    }

    .key.black span {
      color: #fff;
      opacity: 0.9;
      pointer-events: none;
    }

    .visualizer {
      height: 100px;
      background: rgba(255, 202, 58, 0.85);
      margin: 20px 0;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      border: 4px solid rgba(255, 89, 94, 0.85);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
    }

    .visualizer-bar {
      position: absolute;
      bottom: 0;
      width: 3px;
      background: linear-gradient(to top, 
        #fff,
        #ffd93d
      );
      transition: height 0.1s;
      box-shadow: 0 0 10px #ffd93d;
      border-radius: 3px 3px 0 0;
    }

    /* Restore black key positions for realistic keyboard */
    /* These values are tuned for 60px white keys and 40px black keys */
    .key.black[data-note="C#4"] { left: 136px; }
    .key.black[data-note="D#4"] { left: 200px; }
    .key.black[data-note="F#4"] { left: 332px; }
    .key.black[data-note="G#4"] { left: 396px; }
    .key.black[data-note="A#4"] { left: 466px; }
    .key.black[data-note="C#5"] { left: 594px; }
    .key.black[data-note="D#5"] { left: 658px; }

    .pattern-select {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.2);
      border: 3px solid #fff;
      border-radius: 12px;
      color: #fff;
      font-family: 'Patrick Hand', cursive;
      font-size: 1.1em;
      cursor: pointer;
      outline: none;
      transition: all 0.3s ease;
      box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.1);
    }

    .pattern-select:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2),
                  inset 0 0 15px rgba(255, 255, 255, 0.2);
    }

    .pattern-select option {
      background: #905CFF;
      color: #fff;
      font-family: 'Patrick Hand', cursive;
    }

    @media (max-width: 768px) {
      .navbar {
        height: 280px;
      }
      
      .nav-links {
        gap: 0.6rem;
        flex-direction: row;
        justify-content: center;
        flex-wrap: nowrap;
        padding: 0 0.5rem;
        transform: translateY(120px);
      }

      .nav-links a {
        padding: 0.5rem 0.6rem;
        font-size: 0.9rem;
        min-width: auto;
      }

      .container {
        grid-template-columns: 1fr;
      }

      .key {
        width: 45px;
        height: 140px;
      }

      .key.black {
        width: 30px;
        height: 90px;
      }

      .site-title {
        font-size: 8.25em;
      }
    }

    @media screen and (max-width: 480px) {
      .navbar {
        height: 260px;
      }

      .nav-links {
        gap: 0.6rem;
      }

      .nav-links a {
        padding: 0.3rem 0.6rem;
        font-size: 0.85rem;
      }

      .key {
        width: 35px;
        height: 120px;
      }

      .key.black {
        width: 25px;
        height: 75px;
      }

      .key span {
        font-size: 0.9em;
      }
    }

    .tool-dropdown {
      display: block;
      position: relative;
    }
    .tool-dropdown-content {
      display: none;
      position: absolute;
      min-width: 170px;
      left: 50%;
      transform: translateX(-50%);
      top: 100%;
      background: rgba(138, 201, 38, 0.95);
      box-shadow: 0 4px 18px rgba(60, 117, 180, 0.13);
      border-radius: 12px;
      padding: 0.4rem 0;
      border: none;
      z-index: 100;
      transition: opacity 0.18s;
    }
    .tool-dropdown-content a {
      background: none !important;
      color: #fff;
      padding: 0.7rem 1.2rem;
      text-decoration: none;
      display: block;
      font-family: 'Work Sans', sans-serif;
      font-size: 1.08rem;
      border-radius: 8px;
      transition: background 0.18s, color 0.18s;
      margin: 0 0.3rem;
      text-align: left;
      box-shadow: none;
    }
    .tool-dropdown-content a:hover {
      background: #b6e35a;
      color: #255080;
    }
    .tool-dropdown:hover .tool-dropdown-content {
      display: block;
    }
    .tool-link {
      display: block;
      font-family: 'Patrick Hand', cursive;
      text-decoration: none;
      color: #fff;
      padding: 0.8rem 1.4rem;
      border-radius: 16px;
      min-width: 100px;
      text-align: center;
      background: rgba(138, 201, 38, 0.85);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      cursor: pointer;
      user-select: none;
      position: relative;
      z-index: 2;
      padding-right: 2.2rem;
    }
    .tool-link::after {
      content: '';
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 5px solid #fff;
      transition: transform 0.3s ease;
    }
    .tool-dropdown:hover .tool-link::after {
      transform: translateY(-50%) rotate(180deg);
    }
    .tool-link:hover, .tool-dropdown:focus-within .tool-link {
      transform: translateY(-2px) scale(1.1);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3), 0 3px 6px rgba(0,0,0,0.2);
      filter: brightness(1.1);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
 
  <div class="content-container">
    <div class="synth-container">
      <h1>🎛️ Synthesizer!</h1>
      <p>Press the keys or use your keyboard to play! 🎶</p>
      
      <div class="visualizer" id="visualizer"></div>

      <div class="controls-container">
        <div class="instrument-select">
          <label>Choose Instrument:</label>
          <div class="instrument-list">
            <button class="instrument-btn active" data-instrument="spaceOrgan">Space Organ</button>
            <button class="instrument-btn" data-instrument="clarinet">Clarinet</button>
            <button class="instrument-btn" data-instrument="flute">Flute</button>
            <button class="instrument-btn" data-instrument="harpsichord">Harpsichord</button>
            <button class="instrument-btn" data-instrument="guitar">Guitar</button>
            <button class="instrument-btn" data-instrument="trumpet">Trumpet</button>
            <button class="instrument-btn" data-instrument="oboe">Oboe</button>
            <button class="instrument-btn" data-instrument="organ">Organ</button>
            <button class="instrument-btn" data-instrument="strings">Strings</button>
            <button class="instrument-btn" data-instrument="woof">🐕 Woof</button>
          </div>
          <button class="randomize-btn">🎲 Randomize Settings!</button>
        </div>
      </div>

      <div class="container">
        <div class="knob">
          <label for="detune">Detune</label>
          <input id="detune" type="range" min="-1200" max="1200" value="0">
        </div>
        <div class="knob">
          <label for="filter">Filter Cutoff</label>
          <input id="filter" type="range" min="100" max="5000" value="1500">
        </div>
        <div class="knob">
          <label for="reverb">Reverb</label>
          <input id="reverb" type="range" min="0" max="1" step="0.01" value="0.2">
        </div>
        <div class="knob">
          <label for="distortion">Distortion</label>
          <input id="distortion" type="range" min="0" max="1" step="0.01" value="0">
        </div>
        <div class="knob">
          <label for="oscillator">Oscillator</label>
          <input id="oscillator" type="range" min="0" max="3" step="1" value="0">
        </div>
        <div class="knob">
          <label for="arpSpeed">Arp Speed</label>
          <input id="arpSpeed" type="range" min="0.1" max="2" step="0.1" value="0.5">
        </div>
        <div class="knob">
          <label for="arpPattern">Arp Pattern</label>
          <select id="arpPattern" class="pattern-select">
            <option value="off" selected>Off</option>
            <option value="up">Up</option>
            <option value="down">Down</option>
            <option value="upDown">Up & Down</option>
            <option value="random">Random</option>
          </select>
        </div>
        <div class="knob">
          <label for="volume">Volume</label>
          <input id="volume" type="range" min="0" max="1" step="0.01" value="0.7">
        </div>
        <div class="knob">
          <label for="delay">Delay Mix</label>
          <input id="delay" type="range" min="0" max="1" step="0.01" value="0">
        </div>
        <div class="knob">
          <label for="delayTime">Delay Time</label>
          <input id="delayTime" type="range" min="0.05" max="1" step="0.05" value="0.25">
        </div>
      </div>

      <div class="keyboard" id="keyboard">
        <!-- First octave -->
        <div class="key" data-note="C4"><span>A</span></div>
        <div class="key black" data-note="C#4"><span>W</span></div>
        <div class="key" data-note="D4"><span>S</span></div>
        <div class="key black" data-note="D#4"><span>E</span></div>
        <div class="key" data-note="E4"><span>D</span></div>
        <div class="key" data-note="F4"><span>F</span></div>
        <div class="key black" data-note="F#4"><span>T</span></div>
        <div class="key" data-note="G4"><span>G</span></div>
        <div class="key black" data-note="G#4"><span>Y</span></div>
        <div class="key" data-note="A4"><span>H</span></div>
        <div class="key black" data-note="A#4"><span>U</span></div>
        <div class="key" data-note="B4"><span>J</span></div>
        <!-- Start of second octave -->
        <div class="key" data-note="C5"><span>K</span></div>
        <div class="key black" data-note="C#5"><span>O</span></div>
        <div class="key" data-note="D5"><span>L</span></div>
        <div class="key black" data-note="D#5"><span>P</span></div>
        <div class="key" data-note="E5"><span>;</span></div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <script src="common-fixed.js" defer></script>
  <script>
    // ------------------------------------------------------------------------------------------------
    // Globals & Configuration
    // ------------------------------------------------------------------------------------------------
    let audioContext = null;
    let filterNode, distortionNode, reverbNode, delayNode, delayGainNode, mainGainNode;
    let reverbBuffer = null;

    let currentInstrument = 'spaceOrgan';
    const activeNotes = new Set();
    let voiceObjects = {};       // { noteName: { node: OscillatorNode or AudioBufferSourceNode, gainNode: GainNode, timeoutId: number | null } }
    let arpIntervalId = null;    // ID for setInterval when ARP is active
    let arpStepIndex = 0;

    let currentOscillatorType = 'sine';
    let currentDetuneValue = 0;  // in cents

    // ARP settings (pulled from knobs)
    function getArpSpeed() { return parseFloat(document.getElementById('arpSpeed').value); }
    function getArpPattern() { return document.getElementById('arpPattern').value; }

    // ⏰ Keep track of which notes are currently "held" (for ARP & polyphony)
    const heldNotes = new Set(); // same as activeNotes, but we'll use it to drive ARP

    // Key → Note mapping
    const keyMap = {
      'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4', 'd': 'E4',
      'f': 'F4', 't': 'F#4', 'g': 'G4', 'y': 'G#4', 'h': 'A4',
      'u': 'A#4', 'j': 'B4', 'k': 'C5', 'o': 'C#5', 'l': 'D5',
      'p': 'D#5', ';': 'E5'
    };

    // Note → MIDI (for sample pitch-shifting)
    const NOTE_TO_SEMITONE = {
      'C4': 60, 'C#4': 61, 'D4': 62, 'D#4': 63,
      'E4': 64, 'F4': 65, 'F#4': 66, 'G4': 67,
      'G#4': 68, 'A4': 69, 'A#4': 70, 'B4': 71,
      'C5': 72, 'C#5': 73, 'D5': 74, 'D#5': 75,
      'E5': 76
    };

    // Sample URLs for each instrument (only C4, D4, E4)
    const sampleUrls = {
      clarinet: {
        'C4': 'audio/Instrumentsounds/Clarinet/C4.mp3',
        'D4': 'audio/Instrumentsounds/Clarinet/D4.mp3',
        'E4': 'audio/Instrumentsounds/Clarinet/E4.mp3'
      },
      flute: {
        'C4': 'audio/Instrumentsounds/Flute/C4.mp3',
        'D4': 'audio/Instrumentsounds/Flute/D4.mp3',
        'E4': 'audio/Instrumentsounds/Flute/E4.mp3'
      },
      harpsichord: {
        'C4': 'audio/Instrumentsounds/Harpsichord/C4.mp3',
        'D4': 'audio/Instrumentsounds/Harpsichord/D4.mp3',
        'E4': 'audio/Instrumentsounds/Harpsichord/E4.mp3'
      },
      guitar: {
        'C4': 'audio/Instrumentsounds/Guitar/C4.mp3',
        'D4': 'audio/Instrumentsounds/Guitar/D4.mp3',
        'E4': 'audio/Instrumentsounds/Guitar/E4.mp3'
      },
      trumpet: {
        'C4': 'audio/Instrumentsounds/Trumpet/C4.mp3',
        'D4': 'audio/Instrumentsounds/Trumpet/D4.mp3',
        'E4': 'audio/Instrumentsounds/Trumpet/E4.mp3'
      },
      oboe: {
        'C4': 'audio/Instrumentsounds/Oboe/C4.mp3',
        'D4': 'audio/Instrumentsounds/Oboe/D4.mp3',
        'E4': 'audio/Instrumentsounds/Oboe/E4.mp3'
      },
      organ: {
        'C4': 'audio/Instrumentsounds/Organ/C4.mp3',
        'D4': 'audio/Instrumentsounds/Organ/D4.mp3',
        'E4': 'audio/Instrumentsounds/Organ/E4.mp3'
      },
      strings: {
        'C4': 'audio/Instrumentsounds/Violin/C4.mp3',
        'D4': 'audio/Instrumentsounds/Violin/D4.mp3',
        'E4': 'audio/Instrumentsounds/Violin/E4.mp3'
      },
      woof: {
        'C4': 'audio/Instrumentsounds/Woof.mp3',
        'D4': 'audio/Instrumentsounds/Woof.mp3',
        'E4': 'audio/Instrumentsounds/Woof.mp3'
      }
    };

    // Will hold decoded AudioBuffers:
    const audioBuffers = {}; // { instrumentName: { noteName: AudioBuffer } }

    // ------------------------------------------------------------------------------------------------
    // Utility functions for pitch-shifting
    // ------------------------------------------------------------------------------------------------
    function findNearestSample(instrumentBuffers, desiredNote) {
      const desiredSemitone = NOTE_TO_SEMITONE[desiredNote];
      if (instrumentBuffers[desiredNote]) {
        return { sampleNote: desiredNote, semitoneDelta: 0 };
      }
      let bestNote = null, bestDist = Infinity;
      for (const sampleNote of Object.keys(instrumentBuffers)) {
        const sampleSemitone = NOTE_TO_SEMITONE[sampleNote];
        const dist = Math.abs(desiredSemitone - sampleSemitone);
        if (dist < bestDist) {
          bestDist = dist;
          bestNote = sampleNote;
        }
      }
      if (!bestNote) return null;
      const semitoneDelta = desiredSemitone - NOTE_TO_SEMITONE[bestNote];
      return { sampleNote: bestNote, semitoneDelta };
    }

    function getNoteFrequency(note) {
      const noteMap = {
        'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13,
        'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00,
        'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
        'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25,
        'E5': 659.25
      };
      return noteMap[note] || 440;
    }

    // ------------------------------------------------------------------------------------------------
    // Effect Chain Setup (filter → distortion → reverb → delay → volume → destination)
    // ------------------------------------------------------------------------------------------------
    async function setupEffectsChain() {
      filterNode = audioContext.createBiquadFilter();
      filterNode.type = 'lowpass';
      filterNode.frequency.value = 1500;

      distortionNode = audioContext.createWaveShaper();
      distortionNode.curve = makeDistortionCurve(0);
      distortionNode.oversample = '4x';

      // Create a Convolver + WetGain + DryGain
      reverbNode = audioContext.createConvolver();
      reverbBuffer = await fetchImpulseResponse();
      reverbNode.buffer = reverbBuffer;

      // Two gain nodes to mix dry ↔ wet
      const reverbWetGain = audioContext.createGain();
      const reverbDryGain = audioContext.createGain();
      // Default: 20% wet → 80% dry
      reverbWetGain.gain.value = parseFloat(document.getElementById('reverb').value);
      reverbDryGain.gain.value = 1 - reverbWetGain.gain.value;

      // Delay chain
      delayNode = audioContext.createDelay(5.0);
      delayNode.delayTime.value = 0.2;
      delayGainNode = audioContext.createGain();
      delayGainNode.gain.value = 0.2;

      mainGainNode = audioContext.createGain();
      mainGainNode.gain.value = parseFloat(document.getElementById('volume').value);

      // Chain routing:
      filterNode.connect(distortionNode);
      distortionNode.connect(reverbDryGain);
      distortionNode.connect(reverbNode);
      reverbNode.connect(reverbWetGain);

      const afterReverbMerge = audioContext.createGain();
      reverbDryGain.connect(afterReverbMerge);
      reverbWetGain.connect(afterReverbMerge);

      afterReverbMerge.connect(delayNode);
      delayNode.connect(delayGainNode);
      delayGainNode.connect(mainGainNode);
      afterReverbMerge.connect(mainGainNode);
      mainGainNode.connect(audioContext.destination);

      // Make reverbWetGain and reverbDryGain accessible for the #reverb slider:
      window._reverbWetGain = reverbWetGain;
      window._reverbDryGain = reverbDryGain;
    }

    function makeDistortionCurve(amount) {
      const k = typeof amount === 'number' ? amount : 0;
      const n_samples = 44100;
      const curve = new Float32Array(n_samples);
      const deg = Math.PI / 180;
      for (let i = 0; i < n_samples; i++) {
        const x = (i * 2) / n_samples - 1;
        curve[i] = ((3 + k) * x * 20 * deg) / (Math.PI + k * Math.abs(x));
      }
      return curve;
    }

    async function fetchImpulseResponse() {
      const response = await fetch('audio/impulse1.wav');
      const arrayBuffer = await response.arrayBuffer();
      return await audioContext.decodeAudioData(arrayBuffer);
    }

    // ------------------------------------------------------------------------------------------------
    // Load all audio samples (C4, D4, E4) for each instrument
    // ------------------------------------------------------------------------------------------------
    async function loadAllSamples() {
      for (const [instr, notes] of Object.entries(sampleUrls)) {
        audioBuffers[instr] = {};
        for (const [note, url] of Object.entries(notes)) {
          try {
            const resp = await fetch(url);
            const arrayBuf = await resp.arrayBuffer();
            const decoded = await audioContext.decodeAudioData(arrayBuf);
            audioBuffers[instr][note] = decoded;
          } catch (err) {
            console.warn(`Failed to load ${instr} ${note} from ${url}:`, err);
          }
        }
      }
      console.log('✅ All sample URLs decoded (or attempted).');
    }

    // ------------------------------------------------------------------------------------------------
    // Initialize AudioContext and entire setup on first user interaction
    // ------------------------------------------------------------------------------------------------
    async function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      await audioContext.resume(); // Ensure context is running

      // 1) Build a minimal "dry" chain immediately, so oscillators can play:
      filterNode = audioContext.createBiquadFilter();
      filterNode.type = 'lowpass';
      filterNode.frequency.value = parseFloat(document.getElementById('filter').value);

      distortionNode = audioContext.createWaveShaper();
      distortionNode.curve = makeDistortionCurve(parseFloat(document.getElementById('distortion').value) * 100);
      distortionNode.oversample = '4x';

      delayNode = audioContext.createDelay(5.0);
      delayNode.delayTime.value = parseFloat(document.getElementById('delayTime').value);
      delayGainNode = audioContext.createGain();
      delayGainNode.gain.value = parseFloat(document.getElementById('delay').value);

      mainGainNode = audioContext.createGain();
      mainGainNode.gain.value = parseFloat(document.getElementById('volume').value);

      // Wire up: filter → distortion → delay → mainGain → destination
      filterNode.connect(distortionNode);
      distortionNode.connect(delayNode);
      delayNode.connect(delayGainNode);
      delayGainNode.connect(mainGainNode);
      mainGainNode.connect(audioContext.destination);

      // 2) Kick off reverb loading & patch it in when ready:
      loadReverbInBackground();

      // 3) Kick off sample loading (but do not await it):
      loadAllSamples().then(() => {
        console.log('All samples decoded');
      });
    }

    // ------------------------------------------------------------------------------------------------
    // Play & Stop logic
    // ------------------------------------------------------------------------------------------------
    function playOscillatorNote(note) {
      const osc = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      osc.type = currentOscillatorType;
      osc.frequency.value = getNoteFrequency(note);
      osc.detune.value = currentDetuneValue;
      gainNode.gain.value = 0.3;

      osc.connect(filterNode);
      filterNode.connect(gainNode);
      gainNode.connect(distortionNode);

      osc.start();
      voiceObjects[note] = { node: osc, gainNode: gainNode, timeoutId: null };
    }

    function stopOscillatorNote(note) {
      const v = voiceObjects[note];
      if (!v) return;
      const { node, gainNode, timeoutId } = v;
      if (timeoutId) {
        clearTimeout(timeoutId);
      }
      gainNode.gain.setTargetAtTime(0, audioContext.currentTime, 0.01);
      setTimeout(() => {
        try { node.stop(); } catch (_) {}
      }, 50);
      delete voiceObjects[note];
    }

    function playSampleBasedNote(note) {
      const buffersForInst = audioBuffers[currentInstrument];
      if (!buffersForInst) return;
      const nearest = findNearestSample(buffersForInst, note);
      if (!nearest) return;

      const { sampleNote, semitoneDelta } = nearest;
      const sampleBuffer = buffersForInst[sampleNote];
      if (!sampleBuffer) return;

      const source = audioContext.createBufferSource();
      const gainNode = audioContext.createGain();

      const semitoneRatio = Math.pow(2, semitoneDelta / 12);
      const detuneRatio = Math.pow(2, currentDetuneValue / 1200);
      source.playbackRate.value = semitoneRatio * detuneRatio;

      gainNode.gain.value = currentInstrument === 'woof' ? 3 : 1;

      source.connect(filterNode);
      filterNode.connect(gainNode);
      gainNode.connect(distortionNode);

      source.start();
      voiceObjects[note] = { node: source, gainNode: gainNode, timeoutId: null };
    }

    function stopSampleBasedNote(note) {
      const v = voiceObjects[note];
      if (!v) return;
      const { node, gainNode, timeoutId } = v;
      if (timeoutId) clearTimeout(timeoutId);

      gainNode.gain.setTargetAtTime(0, audioContext.currentTime, 0.01);
      const to = setTimeout(() => {
        try { node.stop(); } catch (_) {}
      }, 50);

      voiceObjects[note].timeoutId = to;
      delete voiceObjects[note];
    }

    function playNote(note) {
      if (!audioContext) { initAudio().then(() => playNote(note)); return; }

      if (currentInstrument === 'spaceOrgan') {
        playOscillatorNote(note);
      } else {
        playSampleBasedNote(note);
      }
      activeNotes.add(note);
      heldNotes.add(note);

      const keyEl = document.querySelector(`[data-note="${note}"]`);
      if (keyEl) keyEl.classList.add('active');

      if (getArpPattern() !== 'off' && heldNotes.size === 1) {
        startArpeggiator();
      }
    }

    function stopNote(note) {
      heldNotes.delete(note);

      if (currentInstrument === 'spaceOrgan') {
        stopOscillatorNote(note);
      } else {
        stopSampleBasedNote(note);
      }
      activeNotes.delete(note);

      const keyEl = document.querySelector(`[data-note="${note}"]`);
      if (keyEl) keyEl.classList.remove('active');

      if (getArpPattern() !== 'off' && heldNotes.size === 0) {
        stopArpeggiator();
      }
    }

    function stopAllNotes() {
      for (const note in voiceObjects) {
        const v = voiceObjects[note];
        if (v.timeoutId) clearTimeout(v.timeoutId);
        try {
          if (v.node.stop) v.node.stop();
        } catch (_) {}
      }
      voiceObjects = {};
      activeNotes.clear();
      heldNotes.clear();

      document.querySelectorAll('.key').forEach((k) => k.classList.remove('active'));
      stopArpeggiator();
    }

    // ------------------------------------------------------------------------------------------------
    // ARPEGGIATOR IMPLEMENTATION
    // ------------------------------------------------------------------------------------------------
    function startArpeggiator() {
      if (arpIntervalId !== null) return;
      const pattern = getArpPattern();
      if (pattern === 'off' || heldNotes.size === 0) return;

      arpStepIndex = 0;
      const speed = getArpSpeed();

      arpIntervalId = setInterval(() => {
        const notesArray = Array.from(heldNotes).sort((a, b) => NOTE_TO_SEMITONE[a] - NOTE_TO_SEMITONE[b]);
        if (notesArray.length === 0) {
          stopArpeggiator();
          return;
        }

        let noteToPlay = null;
        switch (pattern) {
          case 'up':
            noteToPlay = notesArray[arpStepIndex % notesArray.length];
            break;
          case 'down':
            noteToPlay = notesArray[(notesArray.length - 1) - (arpStepIndex % notesArray.length)];
            break;
          case 'upDown':
            {
              const cycleLen = notesArray.length * 2 - 2;
              const idx = arpStepIndex % cycleLen;
              if (idx < notesArray.length) {
                noteToPlay = notesArray[idx];
              } else {
                noteToPlay = notesArray[cycleLen - idx];
              }
            }
            break;
          case 'random':
            noteToPlay = notesArray[Math.floor(Math.random() * notesArray.length)];
            break;
          default:
            break;
        }

        for (const n of notesArray) {
          if (n !== noteToPlay && activeNotes.has(n)) {
            if (currentInstrument === 'spaceOrgan') stopOscillatorNote(n);
            else stopSampleBasedNote(n);
          }
        }

        if (noteToPlay) {
          if (currentInstrument === 'spaceOrgan') {
            playOscillatorNote(noteToPlay);
          } else {
            playSampleBasedNote(noteToPlay);
          }
          activeNotes.add(noteToPlay);
          const keyEl = document.querySelector(`[data-note="${noteToPlay}"]`);
          if (keyEl) keyEl.classList.add('active');

          const gateTime = speed * 0.9 * 1000;
          setTimeout(() => {
            if (activeNotes.has(noteToPlay)) {
              if (currentInstrument === 'spaceOrgan') stopOscillatorNote(noteToPlay);
              else stopSampleBasedNote(noteToPlay);
              const keyEl2 = document.querySelector(`[data-note="${noteToPlay}"]`);
              if (keyEl2) keyEl2.classList.remove('active');
            }
          }, gateTime);
        }

        arpStepIndex++;
      }, speed * 1000);
    }

    function stopArpeggiator() {
      if (arpIntervalId !== null) {
        clearInterval(arpIntervalId);
        arpIntervalId = null;
      }
      activeNotes.forEach((n) => {
        if (heldNotes.has(n)) return;
        if (currentInstrument === 'spaceOrgan') stopOscillatorNote(n);
        else stopSampleBasedNote(n);
        const keyEl2 = document.querySelector(`[data-note="${n}"]`);
        if (keyEl2) keyEl2.classList.remove('active');
      });
      activeNotes.clear();
    }

    // ------------------------------------------------------------------------------------------------
    // Hook up UI Controls (knobs & dropdowns)
    // ------------------------------------------------------------------------------------------------
    document.getElementById('filter').addEventListener('input', (e) => {
      filterNode.frequency.value = parseFloat(e.target.value);
    });

    document.getElementById('distortion').addEventListener('input', (e) => {
      distortionNode.curve = makeDistortionCurve(parseFloat(e.target.value) * 100);
    });

    document.getElementById('reverb').addEventListener('input', (e) => {
      const wet = parseFloat(e.target.value);
      const dry = 1 - wet;
      window._reverbWetGain.gain.setTargetAtTime(wet, audioContext.currentTime, 0.01);
      window._reverbDryGain.gain.setTargetAtTime(dry, audioContext.currentTime, 0.01);
    });

    document.getElementById('delay').addEventListener('input', (e) => {
      delayGainNode.gain.value = parseFloat(e.target.value);
    });

    document.getElementById('delayTime').addEventListener('input', (e) => {
      delayNode.delayTime.value = parseFloat(e.target.value);
    });

    document.getElementById('volume').addEventListener('input', (e) => {
      mainGainNode.gain.value = parseFloat(e.target.value);
    });

    document.getElementById('detune').addEventListener('input', (e) => {
      currentDetuneValue = parseFloat(e.target.value);
    });

    document.getElementById('oscillator').addEventListener('input', (e) => {
      const types = ['sine', 'square', 'triangle', 'sawtooth'];
      currentOscillatorType = types[Math.floor(parseFloat(e.target.value))] || 'sine';
    });

    document.getElementById('arpPattern').addEventListener('change', () => {
      if (heldNotes.size === 0) return;
      if (getArpPattern() === 'off') stopArpeggiator();
      else {
        stopArpeggiator();
        startArpeggiator();
      }
    });

    document.getElementById('arpSpeed').addEventListener('input', () => {
      if (arpIntervalId !== null) {
        stopArpeggiator();
        startArpeggiator();
      }
    });

    // "Randomize Settings!" button
    document.querySelector('.randomize-btn').addEventListener('click', () => {
      document.getElementById('detune').value = (Math.random() * 2400 - 1200).toFixed(0);
      document.getElementById('filter').value = (Math.random() * (5000 - 100) + 100).toFixed(0);
      document.getElementById('reverb').value = Math.random().toFixed(2);
      document.getElementById('distortion').value = Math.random().toFixed(2);
      document.getElementById('oscillator').value = Math.floor(Math.random() * 4);
      document.getElementById('arpSpeed').value = (Math.random() * (2 - 0.1) + 0.1).toFixed(2);
      document.getElementById('arpPattern').value = ['off', 'up', 'down', 'upDown', 'random'][Math.floor(Math.random() * 5)];
      document.getElementById('volume').value = Math.random().toFixed(2);
      document.getElementById('delay').value = Math.random().toFixed(2);
      document.getElementById('delayTime').value = (Math.random() * (1 - 0.05) + 0.05).toFixed(2);

      // Apply immediately:
      currentDetuneValue = parseFloat(document.getElementById('detune').value);
      filterNode.frequency.value = parseFloat(document.getElementById('filter').value);
      distortionNode.curve = makeDistortionCurve(parseFloat(document.getElementById('distortion').value) * 100);
      delayGainNode.gain.value = parseFloat(document.getElementById('delay').value);
      delayNode.delayTime.value = parseFloat(document.getElementById('delayTime').value);
      mainGainNode.gain.value = parseFloat(document.getElementById('volume').value);
      const types = ['sine', 'square', 'triangle', 'sawtooth'];
      currentOscillatorType = types[Math.floor(parseFloat(document.getElementById('oscillator').value))] || 'sine';
      if (arpIntervalId !== null) {
        stopArpeggiator();
        startArpeggiator();
      }
    });

    // ------------------------------------------------------------------------------------------------
    // Keyboard & Mouse/Touch Event Handling
    // ------------------------------------------------------------------------------------------------
    document.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      const note = keyMap[e.key.toLowerCase()];
      if (note) playNote(note);
    });

    document.addEventListener('keyup', (e) => {
      const note = keyMap[e.key.toLowerCase()];
      if (note) stopNote(note);
    });

    window.addEventListener('blur', stopAllNotes);

    document.querySelectorAll('.key').forEach((keyEl) => {
      keyEl.addEventListener('mousedown', () => {
        const note = keyEl.dataset.note;
        playNote(note);
      });
      keyEl.addEventListener('mouseup', () => {
        const note = keyEl.dataset.note;
        stopNote(note);
      });
      keyEl.addEventListener('mouseleave', () => {
        const note = keyEl.dataset.note;
        stopNote(note);
      });
      keyEl.addEventListener('touchstart', (ev) => {
        ev.preventDefault();
        const note = keyEl.dataset.note;
        playNote(note);
      });
      keyEl.addEventListener('touchend', (ev) => {
        ev.preventDefault();
        const note = keyEl.dataset.note;
        stopNote(note);
      });
    });

    // ------------------------------------------------------------------------------------------------
    // Instrument Button Handling
    // ------------------------------------------------------------------------------------------------
    document.querySelectorAll('.instrument-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.instrument-btn').forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');

        currentInstrument = btn.dataset.instrument;
        stopAllNotes();

        const isOrg = currentInstrument === 'spaceOrgan';
        setSynthKnobsEnabled(isOrg);
      });
    });

    function setSynthKnobsEnabled(enabled) {
      const detuneEl = document.getElementById('detune');
      const oscEl = document.getElementById('oscillator');
      detuneEl.disabled = !enabled;
      oscEl.disabled = !enabled;
      detuneEl.parentElement.style.opacity = enabled ? '1' : '0.5';
      oscEl.parentElement.style.opacity = enabled ? '1' : '0.5';
      detuneEl.style.pointerEvents = enabled ? 'auto' : 'none';
      oscEl.style.pointerEvents = enabled ? 'auto' : 'none';
    }

    // Initialize UI knob state
    setSynthKnobsEnabled(true);

    // Only set up audio in response to a user gesture:
    document.addEventListener('click', initAudio, { once: true });
    document.addEventListener('keydown', initAudio, { once: true });
    document.addEventListener('touchstart', initAudio, { once: true });

    // On page unload, stop audio
    window.addEventListener('beforeunload', stopAllNotes);
  </script>
</body>
</html>
