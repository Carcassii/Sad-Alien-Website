<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quirky Web Synth - Sad Alien Studios</title>
  <script src="https://unpkg.com/tone"></script>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Work+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    html {
      scroll-behavior: smooth;
    }
    
    body {
      margin: 0;
      font-family: 'Work Sans', sans-serif;
      background: linear-gradient(to bottom, #0a1d37 0%, #0a1d37 320px, #3c75b4 460px, #a0d2ff 640px, #fffdf9 1000px, #fffdf9 100%);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .navbar {
      position: relative;
      height: 320px;
      background: #0a1d37;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
    }

    .site-title {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Patrick Hand', cursive;
      font-size: 4em;
      color: #fff;
      text-shadow: 0 0 10px #ff5ea5,
                   0 0 20px #ff5ea5,
                   0 0 30px #ff5ea5,
                   0 0 40px #ff5ea5;
      animation: float 6s ease-in-out infinite alternate;
      z-index: 2;
    }

    @keyframes float {
      0%, 100% { transform: translate(-50%, -50%); }
      50% { transform: translate(-50%, -60%); }
    }

    .nav-links {
      list-style: none;
      display: flex;
      gap: 1.5rem;
      margin: 0;
      padding: 0;
      z-index: 2;
      transform: translateY(80px);
      justify-content: center;
      flex-wrap: wrap;
    }

    .nav-links a {
      font-family: 'Patrick Hand', cursive;
      text-decoration: none;
      color: #fff;
      padding: 0.8rem 1.4rem;
      transition: all 0.3s ease;
      border-radius: 16px;
      position: relative;
      font-size: 1.2rem;
      min-width: 100px;
      text-align: center;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    .nav-links li:nth-child(1) a {
      background: rgba(255, 89, 94, 0.85);  /* Crayon Red */
    }
    .nav-links li:nth-child(2) a {
      background: rgba(255, 202, 58, 0.85);  /* Crayon Yellow */
    }
    .nav-links li:nth-child(3) a {
      background: rgba(138, 201, 38, 0.85);  /* Crayon Green */
    }
    .nav-links li:nth-child(4) a {
      background: rgba(25, 130, 196, 0.85);  /* Crayon Blue */
    }
    .nav-links li:nth-child(5) a {
      background: rgba(255, 125, 255, 0.85);  /* Crayon Pink */
    }

    .nav-links a:hover {
      transform: translateY(-2px) scale(1.1);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3), 0 3px 6px rgba(0,0,0,0.2);
      filter: brightness(1.1);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .star {
      position: absolute;
      width: 1px;
      height: 1px;
      background: #fff8cc;
      border-radius: 50%;
      opacity: 0.3;
      animation: twinkle var(--twinkle-duration) infinite alternate;
      box-shadow: 0 0 2px #fff8cc;
    }

    @keyframes twinkle {
      0% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.5); }
      100% { opacity: 0.3; transform: scale(1); }
    }

    .synth-container {
      position: relative;
      background: linear-gradient(145deg, #FF61D8, #905CFF);
      border: 4px solid #fff;
      backdrop-filter: blur(10px);
      border-radius: 30px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      max-width: 800px;
      margin: 120px auto 20px;
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }

    h1 {
      font-family: 'Patrick Hand', cursive;
      font-size: 2.5em;
      margin-bottom: 0.2em;
      text-shadow: 0 0 10px rgba(255, 94, 165, 0.5);
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 10px rgba(255, 94, 165, 0.5);
      }
      to {
        text-shadow: 0 0 20px rgba(255, 94, 165, 0.8),
                     0 0 30px rgba(255, 94, 165, 0.6);
      }
    }

    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .controls-container {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    .instrument-select {
      background: linear-gradient(145deg, #905CFF, #FF61D8);
      border: 3px solid #fff;
      border-radius: 25px;
      padding: 25px;
      color: #fff;
    }

    .instrument-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .instrument-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid #fff;
      color: #fff;
      padding: 12px 16px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Patrick Hand', cursive;
      font-size: 1.1em;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    .instrument-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
    }

    .instrument-btn.active {
      background: #fff;
      color: #905CFF;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    .randomize-btn {
      background: linear-gradient(45deg, #FFB347, #FF61D8);
      border: 3px solid #fff;
      color: #fff;
      padding: 15px 25px;
      border-radius: 20px;
      cursor: pointer;
      font-family: 'Patrick Hand', cursive;
      font-size: 1.3em;
      transition: all 0.3s ease;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      margin-top: 25px;
      width: 100%;
    }

    .randomize-btn:hover {
      transform: scale(1.05) rotate(-2deg);
      box-shadow: 0 0 30px rgba(255, 97, 216, 0.6);
    }

    .knob {
      background: linear-gradient(145deg, #FFB347, #FF61D8);
      border: 3px solid #fff;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .knob:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 8px 25px rgba(255, 97, 216, 0.4);
    }

    .knob label {
      font-family: 'Patrick Hand', cursive;
      font-size: 1.4em;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      margin-bottom: 15px;
    }

    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 12px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      outline: none;
      border: 2px solid #fff;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    input[type=range]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    }

    .keyboard {
      display: flex;
      justify-content: center;
      position: relative;
      margin-top: 30px;
      padding: 20px;
      height: 160px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      border: 3px solid #fff;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
    }

    .key {
      width: 45px;
      height: 140px;
      background: #ffffff;
      border-radius: 0 0 10px 10px;
      cursor: pointer;
      transition: all 0.1s;
      position: relative;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 10px;
      color: #905CFF;
      font-weight: bold;
      margin: 0 2px;
      z-index: 0;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .key.black {
      width: 30px;
      height: 90px;
      background: #905CFF;
      position: absolute;
      z-index: 1;
      color: #fff;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(0, 0, 0, 0.4);
      border-radius: 0 0 8px 8px;
    }

    .key:hover {
      background: #f0f0f0;
      transform: translateY(1px);
    }

    .key.black:hover {
      background: #7B4FD6;
    }

    .key.active {
      background: #FF61D8;
      transform: translateY(2px);
      color: white;
    }

    .key.black.active {
      background: #FF8AE2;
    }

    .key span {
      font-size: 0.9em;
      opacity: 0.8;
    }

    .key.black span {
      color: #fff;
      opacity: 0.9;
    }

    .visualizer {
      height: 100px;
      background: rgba(255, 255, 255, 0.1);
      margin: 20px 0;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      border: 3px solid #fff;
      box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.2);
    }

    .visualizer-bar {
      position: absolute;
      bottom: 0;
      width: 3px;
      background: linear-gradient(to top, #FF61D8, #905CFF);
      transition: height 0.1s;
      box-shadow: 0 0 10px rgba(255, 97, 216, 0.5);
    }

    .pattern-select {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid #fff;
      border-radius: 12px;
      color: #fff;
      font-family: 'Patrick Hand', cursive;
      font-size: 1.1em;
      cursor: pointer;
      outline: none;
      transition: all 0.3s ease;
    }

    .pattern-select:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .pattern-select option {
      background: #905CFF;
      color: #fff;
      font-family: 'Patrick Hand', cursive;
    }

    @media (max-width: 768px) {
      .navbar {
        height: 280px;
      }
      
      .nav-links {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        gap: 0.6rem;
        flex-direction: row;
        justify-content: center;
        flex-wrap: nowrap;
        padding: 0 0.5rem;
        transform: translateY(120px);
      }

      .nav-links a {
        padding: 0.5rem 0.6rem;
        font-size: 0.9rem;
        min-width: auto;
      }

      .container {
        grid-template-columns: 1fr;
      }

      .key {
        width: 30px;
        height: 100px;
      }
    }

    @media screen and (max-width: 480px) {
      .navbar {
        height: 260px;
      }

      .nav-links {
        gap: 0.6rem;
      }

      .nav-links a {
        padding: 0.3rem 0.6rem;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav class="navbar">
      <h1 class="site-title">Sad Alien</h1>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="projects.html">Projects</a></li>
        <li><a href="music.html">Music</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </nav>
  </header>

  <div class="synth-container">
    <h1>🎛️ Quirky Synthesizer!</h1>
    <p>Press the keys or use your keyboard to play! 🎶</p>
    
    <div class="visualizer" id="visualizer"></div>

    <div class="controls-container">
      <div class="instrument-select">
        <label>Choose Instrument:</label>
        <div class="instrument-list">
          <button class="instrument-btn active" data-instrument="spaceOrgan">Space Organ</button>
          <button class="instrument-btn" data-instrument="clarinet">Clarinet</button>
          <button class="instrument-btn" data-instrument="flute">Flute</button>
          <button class="instrument-btn" data-instrument="harpsichord">Harpsichord</button>
          <button class="instrument-btn" data-instrument="guitar">Guitar</button>
          <button class="instrument-btn" data-instrument="trumpet">Trumpet</button>
          <button class="instrument-btn" data-instrument="oboe">Oboe</button>
          <button class="instrument-btn" data-instrument="organ">Organ</button>
          <button class="instrument-btn" data-instrument="strings">Strings</button>
          <button class="instrument-btn" data-instrument="woof">🐕 Woof</button>
        </div>
        <button class="randomize-btn">🎲 Randomize Settings!</button>
      </div>
    </div>

    <div class="container">
      <div class="knob">
        <label for="detune">Detune</label>
        <input id="detune" type="range" min="-1200" max="1200" value="0">
      </div>
      <div class="knob">
        <label for="filter">Filter Cutoff</label>
        <input id="filter" type="range" min="100" max="5000" value="1500">
      </div>
      <div class="knob">
        <label for="reverb">Reverb</label>
        <input id="reverb" type="range" min="0" max="1" step="0.01" value="0.2">
      </div>
      <div class="knob">
        <label for="distortion">Distortion</label>
        <input id="distortion" type="range" min="0" max="1" step="0.01" value="0">
      </div>
      <div class="knob">
        <label for="oscillator">Oscillator</label>
        <input id="oscillator" type="range" min="0" max="3" step="1" value="0">
      </div>
      <div class="knob">
        <label for="arpSpeed">Arp Speed</label>
        <input id="arpSpeed" type="range" min="0.1" max="2" step="0.1" value="0.5">
      </div>
      <div class="knob">
        <label for="arpPattern">Arp Pattern</label>
        <select id="arpPattern" class="pattern-select">
          <option value="up">Up</option>
          <option value="down">Down</option>
          <option value="upDown">Up & Down</option>
          <option value="random">Random</option>
          <option value="off">Off</option>
        </select>
      </div>
      <div class="knob">
        <label for="volume">Volume</label>
        <input id="volume" type="range" min="0" max="1" step="0.01" value="0.7">
      </div>
      <div class="knob">
        <label for="delay">Delay Mix</label>
        <input id="delay" type="range" min="0" max="1" step="0.01" value="0">
      </div>
      <div class="knob">
        <label for="delayTime">Delay Time</label>
        <input id="delayTime" type="range" min="0.05" max="1" step="0.05" value="0.25">
      </div>
    </div>

    <div class="keyboard" id="keyboard">
      <!-- First octave -->
      <div class="key" data-note="C4"><span>A</span></div>
      <div class="key black" data-note="C#4"><span>W</span></div>
      <div class="key" data-note="D4"><span>S</span></div>
      <div class="key black" data-note="D#4"><span>E</span></div>
      <div class="key" data-note="E4"><span>D</span></div>
      <div class="key" data-note="F4"><span>F</span></div>
      <div class="key black" data-note="F#4"><span>T</span></div>
      <div class="key" data-note="G4"><span>G</span></div>
      <div class="key black" data-note="G#4"><span>Y</span></div>
      <div class="key" data-note="A4"><span>H</span></div>
      <div class="key black" data-note="A#4"><span>U</span></div>
      <div class="key" data-note="B4"><span>J</span></div>
      <!-- Start of second octave -->
      <div class="key" data-note="C5"><span>K</span></div>
      <div class="key black" data-note="C#5"><span>O</span></div>
      <div class="key" data-note="D5"><span>L</span></div>
      <div class="key black" data-note="D#5"><span>P</span></div>
      <div class="key" data-note="E5"><span>;</span></div>
    </div>
  </div>

  <script>
    // Create random stars
    function createStars() {
      const navbar = document.querySelector('.navbar');
      const numStars = 200; // Number of stars
      
      for (let i = 0; i < numStars; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        
        // Random position
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        
        // Random size (0.5px to 2px)
        const size = 0.5 + Math.random() * 1.5;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        
        // Random twinkle duration (2-6 seconds)
        star.style.setProperty('--twinkle-duration', `${2 + Math.random() * 4}s`);
        
        // Random animation delay
        star.style.animationDelay = `${Math.random() * 4}s`;
        
        navbar.appendChild(star);
      }
    }

    // Call the function when the page loads
    window.addEventListener('load', createStars);

    // Create visualizer
    const visualizer = document.getElementById('visualizer');
    const barCount = 32;
    const bars = [];
    
    for (let i = 0; i < barCount; i++) {
      const bar = document.createElement('div');
      bar.className = 'visualizer-bar';
      bar.style.left = `${(i / barCount) * 100}%`;
      visualizer.appendChild(bar);
      bars.push(bar);
    }

    // Set up synth with more effects
    const synth = new Tone.PolySynth(Tone.Synth, {
      oscillator: {
        type: 'square8'
      },
      envelope: {
        attack: 0.005,
        decay: 0.2,
        sustain: 0.4,
        release: 0.4
      },
      volume: -12
    });

    const filter = new Tone.Filter(1500, "lowpass");
    const reverb = new Tone.Reverb(2);
    const distortion = new Tone.Distortion(0);
    const limiter = new Tone.Limiter(-3);
    const gain = new Tone.Gain(0.7);
    const analyser = new Tone.Analyser("waveform", 128);
    const delay = new Tone.FeedbackDelay({
      delayTime: 0.25,
      feedback: 0.5,
      wet: 0
    });

    // Chain the effects for the synth
    synth.chain(gain, filter, distortion, delay, reverb, limiter, analyser, Tone.Destination);

    reverb.wet.value = 0.2;
    delay.wet.value = 0;

    const oscillatorTypes = ['sawtooth', 'square', 'sine', 'triangle'];

    const keyMap = {
      'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4', 'd': 'E4',
      'f': 'F4', 't': 'F#4', 'g': 'G4', 'y': 'G#4', 'h': 'A4',
      'u': 'A#4', 'j': 'B4', 'k': 'C5', 'o': 'C#5', 'l': 'D5',
      'p': 'D#5', ';': 'E5'
    };

    // Update visualizer
    function updateVisualizer() {
      const waveform = analyser.getValue();
      
      for (let i = 0; i < bars.length; i++) {
        const index = Math.floor(i * (waveform.length / bars.length));
        const value = Math.abs(waveform[index]) * 200;
        bars[i].style.height = `${value}%`;
      }

      requestAnimationFrame(updateVisualizer);
    }
    updateVisualizer();

    // Add arpeggiator
    let currentArpNotes = [];
    let arpInterval;
    let currentArpStep = 0;
    let isArpeggiating = false;

    const patterns = {
      up: (notes) => [...notes].sort((a, b) => Tone.Frequency(a).toFrequency() - Tone.Frequency(b).toFrequency()),
      down: (notes) => [...notes].sort((a, b) => Tone.Frequency(b).toFrequency() - Tone.Frequency(a).toFrequency()),
      upDown: (notes) => {
        const up = patterns.up(notes);
        const down = patterns.down(notes).slice(1, -1);
        return [...up, ...down];
      },
      random: (notes) => {
        const shuffled = [...notes];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
      },
      off: () => []
    };

    function updateArpeggiator() {
      const pattern = document.getElementById('arpPattern').value;
      const speed = document.getElementById('arpSpeed').value;
      
      // Clear existing interval
      if (arpInterval) {
        clearInterval(arpInterval);
        arpInterval = null;
      }

      if (pattern === 'off') {
        isArpeggiating = false;
        return;
      }

      isArpeggiating = true;
      const interval = 1000 * (2.1 - speed);

      if (currentArpNotes.length > 0) {
        arpInterval = setInterval(() => {
          if (currentArpNotes.length === 0) return;

          const arranged = patterns[pattern](currentArpNotes);
          if (arranged.length === 0) return;

          currentArpStep = (currentArpStep + 1) % arranged.length;
          const note = arranged[currentArpStep];
          
          // Release previous note if any
          if (currentInstrument) {
            currentInstrument.triggerRelease();
          }

          // Play the new note
          if (currentInstrument) {
            currentInstrument.triggerAttack(note);
          }

          // Activate/deactivate keys visually
          document.querySelectorAll('.key').forEach(key => {
            key.classList.remove('active');
            if (key.dataset.note === note) {
              key.classList.add('active');
            }
          });
        }, interval);
      }
    }

    // Update event handlers for key presses with improved note handling
    const activeNotes = new Map(); // Change to Map to store note and key info
    let isMouseDown = false;

    function releaseAllNotes() {
        synth.releaseAll();
        activeNotes.forEach((key, note) => {
            if (key) key.classList.remove('active');
        });
        activeNotes.clear();
        currentArpNotes = [];
        if (arpInterval) {
            clearInterval(arpInterval);
            arpInterval = null;
        }
    }

    function handleNoteOn(note, key) {
        if (!isArpeggiating) {
            Tone.start();
            if (currentInstrument) {
                currentInstrument.triggerAttack(note);
            }
            activeNotes.set(note, key);
            if (key) key.classList.add('active');
        }
        if (!currentArpNotes.includes(note)) {
            currentArpNotes.push(note);
            if (isArpeggiating) {
                updateArpeggiator();
            }
        }
    }

    function handleNoteOff(note, key) {
        if (!isArpeggiating && currentInstrument) {
            currentInstrument.triggerRelease(note);
            if (key) key.classList.remove('active');
        }
        activeNotes.delete(note);
        currentArpNotes = currentArpNotes.filter(n => n !== note);
        if (currentArpNotes.length === 0 && arpInterval) {
            clearInterval(arpInterval);
            arpInterval = null;
        }
    }

    // Update keyboard event listeners with improved handling
    const keyboard = document.getElementById('keyboard');
    const keys = keyboard.getElementsByClassName('key');

    Array.from(keys).forEach(key => {
        const note = key.dataset.note;
        
        key.addEventListener('mousedown', () => {
            isMouseDown = true;
            handleNoteOn(note, key);
        });
        
        key.addEventListener('mouseup', () => {
            isMouseDown = false;
            handleNoteOff(note, key);
        });
        
        key.addEventListener('mouseleave', () => {
            if (isMouseDown && activeNotes.has(note)) {
                handleNoteOff(note, key);
            }
        });
        
        key.addEventListener('mouseenter', () => {
            if (isMouseDown) {
                handleNoteOn(note, key);
            }
        });

        key.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleNoteOn(note, key);
        });
        
        key.addEventListener('touchend', (e) => {
            e.preventDefault();
            handleNoteOff(note, key);
        });
    });

    // Update computer keyboard event listeners
    const pressedKeys = new Set();
    
    document.addEventListener('keydown', (e) => {
        if (e.repeat) return;
        const note = keyMap[e.key.toLowerCase()];
        if (note && !pressedKeys.has(e.key.toLowerCase())) {
            pressedKeys.add(e.key.toLowerCase());
            const key = Array.from(keys).find(k => k.dataset.note === note);
            handleNoteOn(note, key);
        }
    });

    document.addEventListener('keyup', (e) => {
        const note = keyMap[e.key.toLowerCase()];
        if (note) {
            pressedKeys.delete(e.key.toLowerCase());
            const key = Array.from(keys).find(k => k.dataset.note === note);
            handleNoteOff(note, key);
        }
    });

    // Add more robust cleanup events
    window.addEventListener('blur', releaseAllNotes);
    window.addEventListener('mouseup', () => {
        isMouseDown = false;
        if (!isArpeggiating) {
            releaseAllNotes();
        }
    });
    document.addEventListener('mouseleave', releaseAllNotes);

    // Add arpeggiator control listeners
    document.getElementById('arpPattern').addEventListener('change', updateArpeggiator);
    document.getElementById('arpSpeed').addEventListener('input', updateArpeggiator);

    // Control changes
    document.getElementById('detune').addEventListener('input', (e) => {
      if (currentInstrument === synth) {
        synth.detune.value = e.target.value;
      } else {
        currentInstrument.detune = e.target.value;
      }
    });

    document.getElementById('filter').addEventListener('input', (e) => {
      filter.frequency.value = e.target.value;
    });

    document.getElementById('reverb').addEventListener('input', (e) => {
      reverb.wet.value = e.target.value;
    });

    document.getElementById('distortion').addEventListener('input', (e) => {
      distortion.distortion = e.target.value;
    });

    document.getElementById('oscillator').addEventListener('input', (e) => {
      if (currentInstrument === synth) {
        const types = ['sine', 'square', 'sawtooth', 'triangle'];
        const type = types[Math.floor(e.target.value)];
        synth.set({
          oscillator: { type }
        });
      }
    });

    document.getElementById('volume').addEventListener('input', (e) => {
      gain.gain.value = e.target.value;
    });

    document.getElementById('delay').addEventListener('input', (e) => {
      delay.wet.value = e.target.value;
    });

    // Add delay time control
    document.getElementById('delayTime').addEventListener('input', (e) => {
      delay.delayTime.value = parseFloat(e.target.value);
    });

    // Instrument presets
    const instruments = {
      spaceOrgan: {
        type: 'synth',
        settings: {
          oscillator: { 
            type: 'custom',
            partials: [1, 0.3, 0.8, 0.2, 0.5, 0.1],
            phase: 45
          },
          envelope: { 
            attack: 0.2, 
            decay: 1.2, 
            sustain: 0.8, 
            release: 2.0 
          }
        }
      },
      clarinet: {
        type: 'sampler',
        sample: 'audio/Clarinet.mp3',
        settings: {
          attack: 0.1,
          release: 0.5
        }
      },
      flute: {
        type: 'sampler',
        sample: 'audio/Flute.mp3',
        settings: {
          attack: 0.1,
          release: 0.3
        }
      },
      harpsichord: {
        type: 'sampler',
        sample: 'audio/Harpsichord.mp3',
        settings: {
          attack: 0.01,
          release: 1.0
        }
      },
      guitar: {
        type: 'sampler',
        sample: 'audio/Guitar.mp3',
        settings: {
          attack: 0.05,
          release: 0.8
        }
      },
      trumpet: {
        type: 'sampler',
        sample: 'audio/Trumpet.mp3',
        settings: {
          attack: 0.1,
          release: 0.4
        }
      },
      oboe: {
        type: 'sampler',
        sample: 'audio/Oboe.mp3',
        settings: {
          attack: 0.1,
          release: 0.5
        }
      },
      organ: {
        type: 'sampler',
        sample: 'audio/Organ.mp3',
        settings: {
          attack: 0.2,
          release: 1.0
        }
      },
      strings: {
        type: 'sampler',
        sample: 'audio/Strings.mp3',
        settings: {
          attack: 0.3,
          release: 1.5
        }
      },
      crystalBell: {
        oscillator: { 
          type: 'custom',
          partials: [1, 0.1, 0.8, 0.1, 0.4], // Crystalline harmonics
          phase: 90
        },
        envelope: { 
          attack: 0.001, 
          decay: 2.0, 
          sustain: 0.1, 
          release: 3.0 
        },
        filterEnvelope: { 
          attack: 0.001, 
          decay: 1.5, 
          sustain: 0.2, 
          release: 2.0, 
          baseFrequency: 2000, 
          octaves: 3 
        }
      },
      alienVoice: {
        oscillator: { 
          type: 'custom',
          partials: [0.6, 1, 0.2, 0.7, 0.1], // Otherworldly vocal harmonics
          phase: 30
        },
        envelope: { 
          attack: 0.3, 
          decay: 0.4, 
          sustain: 0.9, 
          release: 0.8 
        },
        filterEnvelope: { 
          attack: 0.2, 
          decay: 0.3, 
          sustain: 0.8, 
          release: 0.6, 
          baseFrequency: 500, 
          octaves: 5 
        }
      },
      cosmicRays: {
        oscillator: { 
          type: 'custom',
          partials: [0.3, 1, 0.5, 0.2, 0.8, 0.1], // High-energy particle sounds
          phase: 60
        },
        envelope: { 
          attack: 0.05, 
          decay: 0.8, 
          sustain: 0.4, 
          release: 1.2 
        },
        filterEnvelope: { 
          attack: 0.08, 
          decay: 0.6, 
          sustain: 0.4, 
          release: 1.0, 
          baseFrequency: 1500, 
          octaves: 6 
        }
      },
      nebulaCloud: {
        oscillator: { 
          type: 'custom',
          partials: [0.2, 0.4, 1, 0.3, 0.6], // Gaseous, swirling harmonics
          phase: 120
        },
        envelope: { 
          attack: 0.4, 
          decay: 1.5, 
          sustain: 0.7, 
          release: 2.5 
        },
        filterEnvelope: { 
          attack: 0.3, 
          decay: 1.2, 
          sustain: 0.6, 
          release: 2.0, 
          baseFrequency: 200, 
          octaves: 5 
        }
      },
      quantumWave: {
        oscillator: { 
          type: 'custom',
          partials: [0.5, 1, 0.3, 0.7, 0.2, 0.4], // Quantum probability waves
          phase: 15
        },
        envelope: { 
          attack: 0.001, 
          decay: 0.6, 
          sustain: 0.3, 
          release: 1.0 
        },
        filterEnvelope: { 
          attack: 0.001, 
          decay: 0.4, 
          sustain: 0.2, 
          release: 0.8, 
          baseFrequency: 1000, 
          octaves: 4 
        }
      },
      blackHole: {
        oscillator: { 
          type: 'custom',
          partials: [0.1, 0.3, 1, 0.2, 0.4, 0.1], // Deep space harmonics
          phase: 180
        },
        envelope: { 
          attack: 0.2, 
          decay: 2.0, 
          sustain: 0.8, 
          release: 3.0 
        },
        filterEnvelope: { 
          attack: 0.2, 
          decay: 1.5, 
          sustain: 0.6, 
          release: 2.5, 
          baseFrequency: 100, 
          octaves: 7 
        }
      },
      starDust: {
        oscillator: { 
          type: 'custom',
          partials: [0.8, 0.4, 1, 0.2, 0.6, 0.1], // Sparkling harmonics
          phase: 75
        },
        envelope: { 
          attack: 0.01, 
          decay: 1.0, 
          sustain: 0.2, 
          release: 1.5 
        },
        filterEnvelope: { 
          attack: 0.01, 
          decay: 0.8, 
          sustain: 0.3, 
          release: 1.2, 
          baseFrequency: 2500, 
          octaves: 3 
        }
      },
      wormhole: {
        oscillator: { 
          type: 'custom',
          partials: [0.4, 1, 0.6, 0.3, 0.8, 0.2], // Space-time bending harmonics
          phase: 150
        },
        envelope: { 
          attack: 0.15, 
          decay: 1.8, 
          sustain: 0.5, 
          release: 2.2 
        },
        filterEnvelope: { 
          attack: 0.1, 
          decay: 1.4, 
          sustain: 0.4, 
          release: 1.8, 
          baseFrequency: 800, 
          octaves: 5 
        }
      },
      woof: {
        oscillator: { 
          type: 'custom',
          partials: [0.8, 0.4, 1, 0.2, 0.6, 0.1], // Woof harmonics
          phase: 75
        },
        envelope: { 
          attack: 0.01, 
          decay: 1.0, 
          sustain: 0.2, 
          release: 1.5 
        },
        filterEnvelope: { 
          attack: 0.01, 
          decay: 0.8, 
          sustain: 0.3, 
          release: 1.2, 
          baseFrequency: 2500, 
          octaves: 3 
        }
      }
    };

    // Create samplers for each instrument
    const samplers = {};
    let currentInstrument = synth;

    async function initializeSamplers() {
      try {
        const instrumentFiles = {
          'clarinet': 'Clarinet.mp3',
          'flute': 'Flute.mp3',
          'harpsichord': 'Harpsichord.mp3',
          'guitar': 'Guitar.mp3',
          'trumpet': 'Trumpet.mp3',
          'oboe': 'Oboe.mp3',
          'organ': 'Organ.mp3',
          'strings': 'Strings.mp3',
          'woof': 'Woof.mp3'
        };

        for (const [name, file] of Object.entries(instrumentFiles)) {
          console.log(`Loading ${name} sampler...`);
          samplers[name] = new Tone.Sampler({
            urls: {
              "C4": `audio/${file}`
            },
            onload: () => {
              console.log(`${name} sampler loaded successfully`);
            }
          });
          // Connect each sampler to the effects chain
          samplers[name].chain(gain, filter, distortion, delay, reverb, limiter, analyser, Tone.Destination);
        }
      } catch (error) {
        console.error("Error loading samplers:", error);
      }
    }

    // Initialize when page loads
    window.addEventListener('load', async () => {
      await Tone.start();
      await initializeSamplers();
    });

    // Update instrument selection handler
    document.querySelectorAll('.instrument-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const instrumentName = btn.dataset.instrument;
        
        // Remove active class from all buttons
        document.querySelectorAll('.instrument-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        try {
          if (instrumentName === 'spaceOrgan') {
            currentInstrument = synth;
            applyInstrument(instrumentName);
          } else if (samplers[instrumentName]) {
            await Tone.start();
            currentInstrument = samplers[instrumentName];
            console.log(`Switched to ${instrumentName}`);
          }
        } catch (error) {
          console.error(`Error switching to ${instrumentName}:`, error);
          currentInstrument = synth;
        }
      });
    });

    // Function to apply instrument settings
    function applyInstrument(instrumentName) {
      const settings = instruments[instrumentName];
      if (settings.type === 'synth') {
        synth.set(settings.settings);
        // Keep heavy effects only for the synth
        reverb.wet.value = 0.6;
        filter.frequency.value = 1500;
        distortion.distortion = 0.2;
        delay.wet.value = 0.2;
      } else {
        // For sampled instruments, use minimal effects to preserve natural sound
        switch(instrumentName) {
          case 'clarinet':
            reverb.wet.value = 0.1;
            filter.frequency.value = 5000; // Very light filtering
            distortion.distortion = 0;
            delay.wet.value = 0;
            break;
          case 'flute':
            reverb.wet.value = 0.15;
            filter.frequency.value = 5000;
            distortion.distortion = 0;
            delay.wet.value = 0;
            break;
          case 'harpsichord':
            reverb.wet.value = 0.1;
            filter.frequency.value = 5000;
            distortion.distortion = 0;
            delay.wet.value = 0;
            break;
          case 'guitar':
            reverb.wet.value = 0.2;
            filter.frequency.value = 5000;
            distortion.distortion = 0;
            delay.wet.value = 0.1;
            break;
          case 'trumpet':
            reverb.wet.value = 0.1;
            filter.frequency.value = 5000;
            distortion.distortion = 0;
            delay.wet.value = 0;
            break;
          case 'oboe':
            reverb.wet.value = 0.1;
            filter.frequency.value = 5000;
            distortion.distortion = 0;
            delay.wet.value = 0;
            break;
          case 'organ':
            reverb.wet.value = 0.2;
            filter.frequency.value = 5000;
            distortion.distortion = 0;
            delay.wet.value = 0;
            break;
          case 'strings':
            reverb.wet.value = 0.2;
            filter.frequency.value = 5000;
            distortion.distortion = 0;
            delay.wet.value = 0.1;
            break;
          case 'woof':
            reverb.wet.value = 0.2;
            filter.frequency.value = 5000;
            distortion.distortion = 0;
            delay.wet.value = 0;
            break;
        }
      }

      // Update UI controls to match new settings
      document.getElementById('reverb').value = reverb.wet.value;
      document.getElementById('filter').value = filter.frequency.value;
      document.getElementById('distortion').value = distortion.distortion;
      document.getElementById('delay').value = delay.wet.value;
    }

    // Randomize function
    function randomizeSettings() {
      const detuneValue = Math.random() * 2400 - 1200;
      const filterValue = Math.random() * 4900 + 100;
      const reverbValue = Math.random();
      const distortionValue = Math.random();
      const oscillatorValue = Math.floor(Math.random() * 4);

      document.getElementById('detune').value = detuneValue;
      document.getElementById('filter').value = filterValue;
      document.getElementById('reverb').value = reverbValue;
      document.getElementById('distortion').value = distortionValue;
      document.getElementById('oscillator').value = oscillatorValue;

      synth.detune.value = detuneValue;
      filter.frequency.value = filterValue;
      reverb.wet.value = reverbValue;
      distortion.distortion = distortionValue;
      synth.oscillator.type = oscillatorTypes[oscillatorValue];

      document.getElementById('arpSpeed').value = 0.1 + Math.random() * 1.9;
      const patterns = ['up', 'down', 'upDown', 'random', 'off'];
      document.getElementById('arpPattern').value = patterns[Math.floor(Math.random() * patterns.length)];
      updateArpeggiator();
    }

    // Add event listeners for instrument buttons
    document.querySelectorAll('.instrument-btn').forEach(btn => {
      btn.addEventListener('click', () => applyInstrument(btn.dataset.instrument));
    });

    // Add event listener for randomize button
    document.querySelector('.randomize-btn').addEventListener('click', randomizeSettings);

    // Initialize with spaceOrgan
    applyInstrument('spaceOrgan');
  </script>
</body>
</html>
